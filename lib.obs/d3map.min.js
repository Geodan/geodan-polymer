/*! d3map VERSION: 0.1.0 19-08-2014 */
var d3map=d3map||{};!function(){"use strict";d3map.map=function(a,b){function c(){var a=o.scale(s.scale()).translate(s.translate())();l.tiles=a,p.scale(s.scale()/2/Math.PI).translate(s.translate()),u.attr("transform","scale("+a.scale+")translate("+a.translate+")"),l.layers().forEach(function(a){a.refresh()})}function d(a,b){var c=b,d=d3.mouse(a);d3.event.stopPropagation(),l.svg.selectAll(".popup").remove();var e=l.svg.append("g");e.attr("class","popup").attr("transform",function(){var a=d[0],b=d[1];return"translate("+a+","+b+")"});var f={name:"root",children:[{name:"model.populator",icon:"./images/menuicons/users_icon.png",label:"Populatie",size:1,action:function(){}},{name:"edit.geom",icon:"./images/menuicons/pencil_icon.png",label:"Bewerken",value:1,action:function(a){l.draw({feature:a})}},{name:"delete",icon:"./images/menuicons/clipboard_cut_icon.png",label:"Verwijderen",value:1,action:function(a){core.project().items(a.id).deleted(!0).sync()}},{name:"edit.text",icon:"./images/menuicons/text_letter_t_icon.png",label:"Tekst",size:1,action:function(){}}]},g=f;m=150,n=150;var h=Math.min(m,n)/2,i=d3.layout.partition().sort(null).size([2*Math.PI,h*h]).value(function(a){return a.value||1}),j=d3.svg.arc().startAngle(function(a){return a.x}).endAngle(function(a){return a.x+a.dx}).innerRadius(function(a){return Math.sqrt(.7*a.y)}).outerRadius(function(a){return Math.sqrt(1.5*(a.y+a.dy))}),k=d3.scale.category10(),o=e.append("g"),p=o.append("g").classed("pie popup",!0).attr("width",m).attr("height",n).append("g").attr("class","zoomable");e=p.datum(g).selectAll("arc1").data(i.nodes).enter().append("g").attr("class","arc1").on("click",function(a){l.svg.selectAll(".popup").remove(),d3.event.stopPropagation();var b=a.action;a.action?b(c):console.warn("No action defined for menu item")}).on("mouseover",function(){d3.select(this).append("text").classed("menu_shadow",!0).attr("dy",0).attr("dx",0).text(function(a){return a.label}),d3.select(this).append("text").classed("menu",!0).attr("dy",0).attr("dx",0).text(function(a){return a.label})}).on("mouseout",function(){d3.select(this).style("opacity",1).selectAll("text").remove()}),e.append("path").style("opacity",0).transition().style("opacity",1).attr("d",function(a){return j(a)}).style("stroke","#fff").style("fill",function(a){return"root"==a.name?"none":a.parent&&"P"==a.parent.name?"none":k(a.parent&&"root"==a.parent.name?a.name:a.name)}),e.append("svg:image").attr("transform",function(a){return"translate("+j.centroid(a)+")"}).attr("x",-9).attr("y",-12).attr("width",20).attr("height",24).attr("xlink:href",function(a){return a.icon})}function e(a){this.tile.size(a)}function f(){return this._layers}function g(a){return a.id()?(this._layers.forEach(function(b){return b.id()==a.id()?(a=b,!0):void 0}),this._layers.push(a),!0):(console.warn("Not a valid layer. (No ID)"),!1)}function h(a){return this._layers.forEach(function(b,c){return b.id()==a?(this._layers.splice(c,1),!0):void 0}),!1}function i(){var a=l.vector.append("g").attr("id","drawpointer").append("image").attr("xlink:href",l.curUrl).attr("width",30).attr("height",30).attr("x",-100).attr("y",-100);l.svg.on("mousemove",function(){var b=d3.mouse(this);a.attr("x",b[0]-15),a.attr("y",b[1]-15)}),l.svg.on("click",function(){var a=d3.mouse(this);l.vector.selectAll("#drawpointer").remove(),l.svg.on("mousemove",null),l.svg.on("click",null);var b=l.projection.invert(a);if(core.project())if("new"==l.status){var c="ID"+(new Date).getTime(),d={_id:c,data:{type:"feature",id:c,feature:{type:"Feature",geometry:{type:l.curType,coordinates:b},style:{"marker-url":l.curUrl}}}};core.project().items(d).sync()}else l.feature.geometry.coordinates=b,core.project().items(l.feature.id).data("feature",l.feature).sync(),l.redraw();else console.warn("Can't draw. (No active project)")})}function j(){function a(){function a(){d3.event.preventDefault(),d3.event.stopPropagation();var a=d3.mouse(this);b(a)}function d(){function a(a){for(var b=0,c=0,d=0;d<a.length;d++)c=(d+1)%a.length,b+=a[d][0]*a[c][1],b-=a[c][0]*a[d][1];return b/2}l.vector.selectAll("#drawpointer").remove(),l.svg.on("mousemove",null),l.svg.on("touchmove",null),l.svg.on("click",null),l.svg.on("touchstart",null),l.svg.on("touchend",null);var b=[];c.forEach(function(a){b.push({x:a[0],y:a[1]})}),b=simplify(b),c=[],b.forEach(function(a){c.push([a.x,a.y])}),"Polygon"==l.curType&&c.push(c[0]);var d=a(c)>0;d||c.reverse();var e=[];if(c.forEach(function(a){e.push(l.projection.invert(a))}),"Polygon"==l.curType&&(e=[e]),core.project())if("new"==l.status){var f="ID"+(new Date).getTime(),g={_id:f,data:{type:"feature",feature:{type:"Feature",id:f,geometry:{type:l.curType,coordinates:e},style:{stroke:l.curStroke,fill:l.curFill}}}};core.project().items(g).sync()}else l.feature.geometry.coordinates=e,core.project().items(l.feature.id).data("feature",l.feature).sync(),l.redraw();else console.warn("Can't draw. (No active project)")}l.svg.on("mousemove",a),l.svg.on("touchmove",a),l.svg.on("click",d),l.svg.on("touchend",d)}function b(a){c.push(a),e.attr("d",function(a){return d(a)})}var c=[],d=d3.svg.line().interpolate("basis").x(function(a){return a[0]}).y(function(a){return a[1]}),e=l.vector.append("g").attr("id","drawpointer").append("path").data([c]).attr("class","line").attr("d",d).style("stroke",l.curStroke).style("stroke-width","3px").style("fill",l.curFill).style("fill-opacity",.3);l.svg.on("touchmove",function(){console.log("Touchmove",d3.mouse(this))}),l.svg.on("click",a),l.svg.on("touchstart",function(){d3.event.preventDefault(),console.log("Touchstart"),l.svg.on("touchmove",function(){console.log("Touchmove",d3.mouse(this))}),l.svg.on("touchend",function(){console.log("Touchend"),l.svg.on("touchstart",null),l.svg.on("touchend",null),l.svg.on("touchmove",null)})})}function k(a){this.vector.selectAll("#drawpointer").remove(),a.detail?(this.status="new",this.curType=a.detail.type,this.curUrl=a.detail.url,this.curStroke=a.detail.stroke,this.curFill=a.detail.fill||"none"):(this.status="exists",this.feature=a.feature,this.curType=a.feature.geometry.type,this.curUrl=a.feature.style["marker-url"],this.curStroke=a.feature.style.stroke,this.curFill=a.feature.style.fill||"none"),"Point"==this.curType?i():"LineString"==this.curType?j():"Polygon"==this.curType&&j()}var l=this;this._layers=[];var m=Math.max(960,window.innerWidth),n=Math.max(500,window.innerHeight);this.elem=a;var o=d3.geo.tile().size([m,n]);this.tile=o;var p=d3.geo.mercator().scale((b.zoom<<12||4096)/2/Math.PI).translate([m/2,n/2]);this.projection=p;var q=p(b.center||[0,0]);this.center=q;var r=d3.geo.path().projection(p);this.path=r,this.redraw=c;var s=d3.behavior.zoom().scale(2*p.scale()*Math.PI).scaleExtent([256,1<<24]).translate([m-q[0],n-q[1]]).on("zoom",c);this.zoom=s;var t=d3.select(a).attr("width",m).attr("height",n);this.svg=t,t.on("click",function(){l.svg.selectAll(".popup").remove()});var u=t.append("g").attr("id","raster");this.raster=u;var v=t.append("g").attr("id","vector");return this.vector=v,t.call(s),this.menu=d,this.resize=e,this.layers=f,this.addLayer=g,this.removeLayer=h,this.draw=k,this}}();var d3map=d3map||{};!function(){"use strict";d3map.layer=function(){var a=function(){return this._id},b=function(a){this._opacity=a,this.redraw()},c=function(a){this._isvisible=a,this.redraw(),this.refresh()};return{id:a,setOpacity:b,setVisibility:c}}()}();var d3map=d3map||{};!function(){"use strict";d3map.rasterlayer=function(a,b,c){_.extend(this,d3map.layer),this._id=a,this._type=c.type,this._url=c.url,this._layers=c.layers,this._map=b,this._opacity=1,this._isvisible=!0},d3map.rasterlayer.prototype.clear=function(){this._map.raster.selectAll("."+this._id).remove()},d3map.rasterlayer.prototype.redraw=function(){var a=this,b=this._map.tiles,c=this._map.raster,d=c.selectAll("."+this._id).data(b,function(a){return a}),e=d.enter();this._isvisible?e.append("image").classed(this._id,!0).attr("xlink:href",function(b){var c="";if("tms"==a._type)c=a._url.replace("%7Bs%7D",["a","b","c","d"][4*Math.random()|0]).replace("%7Bz%7D",b[2]).replace("%7Bx%7D",b[0]).replace("%7By%7D",b[1]);else if("wms"==a._type){var d=2<<b[2]-1,e=40075016.68/d,f=-20037508.34+b[0]*e,g=20037508.34-(b[1]+1)*e,h=f+", "+g+","+(f+e)+","+(g+e);c=a._url+"&bbox="+h+"&layers="+a._layers+"&service=WMS&version=1.1.0&request=GetMap&tiled=true&styles=&width=256&height=256&srs=EPSG:900913&transparent=TRUE&format=image%2Fpng"}return c}).attr("width",1).attr("height",1).attr("opacity",a._opacity).attr("x",function(a){return a[0]}).attr("y",function(a){return a[1]}):d.remove(),d.exit().remove()},d3map.rasterlayer.prototype.refresh=function(){var a=this._map.raster,b=a.selectAll("."+this._id);b.style("opacity",this._opacity),this.redraw()}}();var d3map=d3map||{};!function(){"use strict";d3map.vectorlayer=function(a,b,c){_.extend(this,d3map.layer),this._data=c.data,this._id=a,this._map=b,this._r=c.r,this._type=c.type||"path",this._maxzoom=c.maxzoom,this._minzoom=c.minzoom,this._labels=c.labels||!1,this._labelconfig=c.labelconfig,this._style=c.style||{},this._g=this._map.vector.append("g").attr("id",this._id),this._onmouseover=c.onmouseover,this._onclick=c.onclick,this._mouseoverContent=c.mouseoverContent,this._opacity=c.opacity||1,this._isvisible=c.visible||!0},d3map.vectorlayer.prototype.clear=function(){this._map.vector.select("#"+this._id).selectAll(".entity").remove()},d3map.vectorlayer.prototype.redraw=function(){var a=this._map.projection;this.projection=a;var b=(this._map.pointprojection,this._map.clicked,this._map.path),c=this,d=this._style,e=this._labels,f=this._labelconfig,g=d3.select(c._map.elem.parentElement).append("div").attr("id","tooltipdiv").style("position","absolute"),h=function(a){a.origopac||(a.origopac=d3.select(this).style("opacity")),d3.select(this).transition().duration(100).style("opacity",.2*a.origopac);var b="";_(a.properties).each(function(a,c){b=b+"<b>"+c+"</b>"+a+"<br>"}),g.transition().duration(200).style("opacity",.9),g.html(b+"<br/>").style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")},i=function(a){d3.select(this).transition().duration(100).style("opacity",a.origopac),g.transition().duration(500).style("opacity",0),g.transition().delay(1500).style("top","-100px")},j=function(a){c._map.menu(this,a)},k=function(b){var c=d3.select(this);if(b.style&&b.style["marker-url"]&&"Point"==b.geometry.type){a(b.geometry.coordinates)[0],a(b.geometry.coordinates)[1],c.append("image").on("click",j).on("mouseover",h).on("mouseout",i)}else{c.append("path").on("click",j).on("mouseover",h).on("mouseout",i)}},l=function(b){var c=d3.select(this);if(b.style&&b.style["marker-url"]&&"Point"==b.geometry.type){a(b.geometry.coordinates)[0],a(b.geometry.coordinates)[1],c.select("image").attr("xlink:href",function(a){return a.style["marker-url"]}).classed("nodeimg",!0).attr("width",32).attr("height",37).style("opacity",function(a){return a.style.opacity||d.opacity||1})}else{var e=c.select("path");_(d).each(function(a,b){e.style(b,function(a){if("function"==typeof d[b]){var c=d[b];return c(a)}return d[b]})}),_(b.style).each(function(a,b){e.style(b,a)})}},m=function(a){var b=this;_(f.style).each(function(a,c){d3.select(b).style(c,function(a){return a.labelconfig&&a.labelconfig.style&&a.labelconfig.style[c]?a.labelconfig.style[c]:f.style[c]})}),a.labelconfig&&a.labelconfig.style&&_(a.labelconfig.style).each(function(c,d){d3.select(b).style(d,a.labelconfig.style[d])})},n=function(a){return a.style&&a.style.radius?b.pointRadius(a.style.radius):d&&d.radius&&b.pointRadius(d.radius),b(a)};this.pathStyler=n;var o=function(a){var c=b.centroid(a),e=b.bounds(a);if(d&&d.textlocation)switch(d.textlocation){case"ul":c[0]=e[0][0],c[1]=e[0][1];break;case"ur":c[0]=e[1][0],c[1]=e[1][1]}else c[1]=c[1]+20;return c};this.textLocation=o;var p=function(a){if(f.field&&a.properties){var b=a.properties[f.field];return b&&b.length>10?b.substr(0,16)+"...":b}return a.id};this.labelgenerator=p;var q=this._map.vector.select("#"+this._id).selectAll(".entity").data(this._data,function(a){return a.id});if(this._isvisible){var r=q.enter().append("g").classed("entity",!0).attr("id",function(a){return"entity"+a.id});if(r.each(k),e){var s=r.append("g").classed("place-label",!0);s.append("text").attr("x",function(a){return o(a)[0]}).attr("y",function(a){return o(a)[1]}).attr("text-anchor","left").style("stroke","white").style("stroke-width","3px").style("stroke-opacity",.8).text(function(a){return p(a)}),s.append("text").attr("x",function(a){return o(a)[0]}).attr("y",function(a){return o(a)[1]}).attr("text-anchor","left").each(m).text(function(a){return p(a)})}}else q.remove();q.each(l),q.exit().remove().transition().duration(500),this.refresh()},d3map.vectorlayer.prototype.refresh=function(){var a=this,b=this._map.vector.select("#"+this._id).selectAll(".entity"),c=this._map.path,d=this.textLocation,e=this._labels,f=this.pathStyler;this._map.vector.select("#"+this._id).style("opacity",this._opacity),b.each(function(b){var g=d3.select(this),h=c.centroid(b)[0],i=c.centroid(b)[1];if(b.style&&b.style["marker-url"]&&"Point"==b.geometry.type?g.select("image").attr("x",h-12.5).attr("y",i-25):g.select("path").attr("d",f(b)),e){var j=1;a._labelconfig&&a._labelconfig.minzoom&&a._map.zoom.scale()<a._labelconfig.minzoom&&(j=0),g.select(".place-label").style("opacity",j).selectAll("text").attr("x",d(b)[0]).attr("y",d(b)[1])}})},d3map.vectorlayer.prototype.data=function(a){this._map.projection,this._map.pointprojection,this._map.clicked,this._style;this._data=a,this.redraw()}}();var Cop=window.Cop||{};Cop_utils={},Cop_utils.menuconfig={name:"root",children:[{name:"model.populator",icon:"./css/img/users_icon.png",label:"Populatie",size:1},{name:"edit.geom",icon:"./css/img/pencil_icon.png",label:"Bewerken",value:1},{name:"delete",icon:"./css/img/clipboard_cut_icon.png",label:"Verwijderen",value:1},{name:"edit.text",icon:"./css/img/text_letter_t_icon.png",label:"Tekst",size:1}]},Cop_utils.menu=function(a,b,c,d,e){var f=this,g=a.id;d3.selectAll(".popup").remove();var h,i,j=a,k=e.menuconfig;this._svg=i=c,h=i.append("g");{var l=d3.mouse(d);({x:b.layerX,y:b.layerY})}navigator.userAgent.match("Firefox")&&(l[0]=l[0]+10,l[1]=l[1]+10),navigator.userAgent.match("MSIE")&&(l[0]=l[0]-140,l[1]=l[1]+2),h.attr("class","popup").attr("transform",function(){var a=l[0],b=l[1];return"translate("+a+","+b+")"});var m=k;width=150,height=150;var n=Math.min(width,height)/2,o=d3.layout.partition().sort(null).size([2*Math.PI,n*n]).value(function(a){return a.value||1}),p=d3.svg.arc().startAngle(function(a){return a.x}).endAngle(function(a){return a.x+a.dx}).innerRadius(function(a){return Math.sqrt(.7*a.y)}).outerRadius(function(a){return Math.sqrt(1.5*(a.y+a.dy))}),q=d3.scale.category10(),r=h.append("g");if("true"==r.attr("selected"))r.select(".popup").remove(),r.attr("selected","false");else{r.attr("selected","true");var s=r.append("g").classed("pie popup",!0).attr("width",width).attr("height",height).append("g").attr("class","zoomable"),h=s.datum(m).selectAll("arc1").data(o.nodes).enter().append("g").attr("class","arc1").on("click",function(a){r.remove(),d3.event.stopPropagation();var b=a.name;f.trigger(b,{fid:g,layer:j,obj:d})}).on("mouseover",function(){d3.select(this).append("text").classed("menu_shadow",!0).attr("dy",0).attr("dx",0).text(function(a){return a.label}),d3.select(this).append("text").classed("menu",!0).attr("dy",0).attr("dx",0).text(function(a){return a.label})}).on("mouseout",function(){d3.select(this).style("opacity",1).selectAll("text").remove()});h.append("path").style("opacity",0).transition().style("opacity",1).attr("d",function(a){return p(a)}).style("stroke","#fff").style("fill",function(a){return"root"==a.name?"none":a.parent&&"P"==a.parent.name?"none":q(a.parent&&"root"==a.parent.name?a.name:a.name)}),h.append("svg:image").attr("transform",function(a){return"translate("+p.centroid(a)+")"}).attr("x",-9).attr("y",-12).attr("width",20).attr("height",24).attr("xlink:href",function(a){return a.icon})}},_.extend(Cop_utils.menu.prototype,Events),Cop_utils.populator=function(){},Cop_utils.editText=function(){},Cop_utils.textbox=function(a,b){var c=this.map;d3.select(b).on("mouseout",function(){d3.selectAll(".textbox").remove()});var d=(d3.mouse(b),[d3.event.screenX,d3.event.screenY]),e=c.core.project().items(a.properties.key),f=(a.properties.name||"",a.properties.desc||""),g=a.properties.owner||"Anoniem",h="";if(e.permissions("edit")){var i=e.permissions("edit").groups;$.each(i,function(a,b){var d=c.core.project().groups(b).data("name");"public"!=d&&(h+=d)})}var j=c.core.project().groups(),k=[];$.each(j,function(a,b){k.push(b._id)});var l=d3.select("body").append("div").style("left",d[0]+25+"px").style("top",d[1]+-100+"px").classed("textbox popup share ui-draggable",!0),m=l.append("div").classed("sheader",!0).attr("title","Dit object is gemaakt door");m.append("span").classed("group "+h,!0),m.append("span").html(h+" <small>("+g+")</small>");var n=l.append("div").classed("scontent",!0);if(f=f.replace(/\r\n?|\n/g,"<br />"),n.append("div").classed("ssubheader",!0).html(f),sfooter=l.append("div").classed("sfooter",!0).attr("id","permissionlist").html("Gedeeld met:"),e.permissions("view")){var o=e.permissions("view").groups,p=d3.select("#permissionlist").selectAll(".permission").data(o);p.enter().append("span").attr("class",function(a){var b=c.core.project().groups(a).data("name");return"group "+b})}},Cop_utils.ripple=function(a,b,c){console.log(c._map);var d=c._map,e=d.getSize().x,f=d.getSize().y,g=d3.mouse(b),h=d3.select(".leaflet-popup-pane").append("svg");h.attr("class","popup"),h.attr("width",e),h.attr("height",f);h.append("circle").attr("r",10).attr("cx",g[0]).attr("cy",g[1]).style("fill","none").style("stroke","green").transition().duration(2e3).attr("r",500).transition().duration(500).style("opacity",0).remove().call(function(){d3.selectAll(".popup").transition().duration(1e3).remove()})};