<link rel="import" href="../../bower_components/geodan-polymer/elements/g-map.html">
<link rel="import" href="../../bower_components/geodan-polymer/elements/g-drawingmenu.html">
<link rel="import" href="../../bower_components/geodan-polymer/elements/g-suggest.html">
<link rel="import" href="../../bower_components/geodan-polymer/elements/g-item.html">
<link rel="import" href="../../bower_components/geodan-polymer/elements/g-list.html">
<link rel="import" href="../../bower_components/geodan-polymer/elements/g-mapvectorlayer.html">
<link rel="import" href="../../bower_components/geodan-polymer/elements/g-maprasterlayer.html">
<link rel="import" href="../../bower_components/geodan-polymer/elements/g-layermanager.html">
<link rel="import" href="../../bower_components/geodan-polymer/elements/g-layercatalogus.html">
<link rel="import" href="../../bower_components/geodan-polymer/elements/g-geoservermngr.html">
<link rel="import" href="../../bower_components/geodan-polymer/elements/g-dialog.html">
<link rel="import" href="../../bower_components/geodan-polymer/elements/g-cas.html">
<polymer-element name='my-map'>
<template>
    <style>
    g-map {
          position: relative;
          height: 100%;
      }
      g-layermanager {
      	  display: block;
          position: absolute;
          left: 10px;
          top: 50px;
          width: 400px;
          z-index: 102;
      }
      g-layermngr {
          display: block;
          position: absolute;
          left: 10px;
          top: 50px;
          width: 200px;
          height: 600px;
          z-index: 101;
      }
      g-drawingmenu {
          display: block;
          position: absolute;
          left: 10px;
          bottom: 50px;
          width: 200px;
          z-index: 101;
      }
      g-geoservermngr {
          display: block;
          position: absolute;
          right: 10px;
          top: 50px;
          width: 200px;
          z-index: 101;
      }
      g-suggest {
      	  display: block;
          position: absolute;
          right: 10px;
          top: 50px;
          width: 400px;
          z-index: 101;
      }
      g-layercatalogus {
      	  display: block;
          position: absolute;
          right: 10px;
          top: 50px;
          width: 400px;
          z-index: 101;
      }
      #content {
      	  height: 100%;
      }
      #map {
      	  height: 100%;
      }
      #rightbar {
      	  position: absolute;
      	  right: 0px;
      	  top: 0px;
      	  width: 50%;
      	  height: 100%;
      }
      core-collapse {
        margin: 10px 0;
        padding: 15px;
        display: block !important;
        min-height: 20px;
        height: 500px;
      }
    </style>
    <g-cas account="{{account}}"></g-cas>
    
    <div id="map">
    	<g-suggest id="suggest"></g-suggest>
    	<g-drawingmenu id="drawmenu" map="{{map}}"></g-drawingmenu>
		<g-layermanager id="layermngr" map="{{map}}" layers="{{layers}}"></g-layermanager>
		<g-layercatalogus id="layercatalogus" mapType="d3.mappu" activeLayers="{{layers}}" account="{{account}}" filters="{{filters}}"></g-layercatalogus>
		<g-map id="mapelement" latitude="52.2" longitude="5.2" zoomlevel="23">

			<g-maprasterlayer 
				id="Mapbox"
				type="tms"
				url="http://{s}.tiles.mapbox.com/v3/examples.map-i86nkdio/{z}/{x}/{y}.png"
			></g-maprasterlayer>
			<g-mapvectorlayer id="sketch" name="Sketch"></g-mapvectorlayer>
			<g-mapvectorlayer id="location" name="Location"></g-mapvectorlayer>
		<!--			
			<g-maprasterlayer
				id="Transport"
				type="tms"
				visible='false'
				url="http://{s}.tile2.opencyclemap.org/transport/{z}/{x}/{y}.png"
			></g-maprasterlayer>
			<g-maprasterlayer 
				id="pico1"
				type="wms"
				visible="false"
				url= "/service/pico/geoserver/pico/wms?"
				layers= 'pico:pico_sjv_sf'
			></g-maprasterlayer>-->
		<!--
			 <g-mapvectorlayer 
			 	id="gemeenten" 
			 	name="Gemeenten"
			 	visible="true"
			 ></g-mapvectorlayer>	 <!--
			 <g-trainlayer id="nslayer" name="Trains" interval="5000"></g-trainlayer>
		-->
        </g-map>
      </div>
      <!--
      <div id='rightbar' class='list' layout vertical>
      	<input type="text" id="selectedInterval" onfocus="this.select();" value="5000">
      	<input type="button" value="interval" on-click="{{selectInterval}}">
      	<core-selector selected="{{selected}}">
		  <template repeat="{{layer,i in layers}}">
			<core-collapse opened?="{{selected == i}}" fixedSize style="height:600px">
			  <h4>{{layer.name}}</h4>
			  <g-featurelist layer="{{layer}}"></g-featurelist>
			</core-collapse>
		  </template>
		</core-selector>
      </div>
      -->
</template>

<script>
var tmp;
  Polymer({
	ready: function(){
		var self = this;
		this.layers = [];
		// Initialize the instance's "list" property to empty array.
        this.layers = [];
        this.filters = [];
        this.account = {};
        this.activeLayers = [];
		window.setTimeout(function(){ //FIXME
			tmp = self.$.mapelement.map;
			self.$.mapelement.resize();
			self.$.mapelement.map.zoom = 23;
			self.$.mapelement.map.center = [5.2,52];
			self.$.drawmenu.setLayer(self.$.sketch.layer);
		},1000);
		this.$.suggest.addEventListener('location', function(d){
			var center = d.detail.msg.centroid.geometry.coordinates;
			self.$.mapelement.map.center = center;
			//self.$.mapelement.map.zoomToFeature(d.detail.msg.geom); //Doesn't work yet
			var feat = d.detail.msg.geom;
			self.$.location.newdata([feat]);
		});
		this.$.drawmenu.addEventListener('newfeature', function(d){
			self.$.sketch.adddata(d.detail.feature);
		});
		
		
		//this.trains = this.$.nslayer.trains;
		
		d3.json("../../d3.mappu/test/gemeenten_simple.topojson", function(error, data) {
		  if (error) return console.error(error);
		  var feats = topojson.feature(data, data.objects.gemeenten).features;
		  var counter = 0;
		  feats.forEach(function(d){
			d.id = 'id' + counter++;
			//if (self.$.featurelist.selectedList.indexOf(d.id) > -1){
			//	d._selected = true;
			//}
		  });
		  //self.$.gemeenten.newdata(feats);
		});
		
	},
	selectInterval: function(){
		//this.$.nslayer.interval = parseInt(this.$.selectedInterval.value);
	},
	attached: function(){
		var self = this;
		window.setTimeout(function(){ //FIXME
			self.layers = self.$.mapelement.map.layers.filter(function(d){return d.type == 'vector'});
			self.map = self.$.mapelement.map;
			self.$.mapelement.resize();
		},1000);
	}
  });

</script>
</polymer-element>