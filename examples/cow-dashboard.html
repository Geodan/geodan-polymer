<polymer-element name='cow-dashboard'>

<link rel="import" href="../elements/mypoly-wsstatus.html">
<link rel="import" href="../elements/mypoly-item.html">
<link rel="import" href="../elements/project-list.html">
<link rel="import" href="../elements/mypoly-map.html">
<link rel="import" href="../elements/mypoly-maplayer.html">
<link rel="import" href="../elements/mypoly-maprasterlayer.html">
<link rel="import" href="../elements/mypoly-layermngr.html">
<link rel="import" href="../elements/mypoly-geoservermngr.html">
<link rel="import" href="../elements/mypoly-dialog.html">
<link rel="import" href="../elements/geodan-suggest.html">
<!--
<link rel="import" href="../elements/mypoly-peersforcelayout.html">
-->
<link rel="import" href="../elements/icm-login.html">

<template>
<style>

core-header-panel {
    height: 100%;
}
.page {
    height: 100%;
    width: 100%;
}
d3-map {
    height: 100%;
    float: left;
    width: 100%;
}

.content {
    position: absolute; 
    height: 100%;
    width: 100%;
}
d3-layermngr {
    display: block;
    position: absolute;
    right: 0px;
    top: 0px;
    height: 100%;
    width: 200px;
    z-index: 101;
}
   

</style>
<icm-login></icm-login>
<core-header-panel flex>
    <core-toolbar>
      <div>COW dashboard</div>
      <core-icon icon="search"></core-icon>
      <geodan-suggest id="suggest"></geodan-suggest>
    </core-toolbar>
    <div horizontal layout>
      <div>
        <project-list id="project-list"></project-list>
      </div>
      <core-splitter minSize="200px" direction="left"></core-splitter>
      <div class='page content'>
        <d3-map id="mapelement" latitude="52.2" longitude="5.2" zoom="3">
            <d3-maprasterlayer 
                id="mapbox"
                type="tms"
                url="http://{s}.tiles.mapbox.com/v3/examples.map-i86nkdio/{z}/{x}/{y}.png"
            ></d3-rastermaplayer>
            <!--
            <d3-maprasterlayer 
                id="pico1"
                type="wms"
                url= "/service/pico/geoserver/pico/wms?"
                layers= 'pico:pico_sjv_sf'
            ></d3-rastermaplayer>
            -->
            <d3-maplayer name="pathlayer"></d3-maplayer>
            <d3-maplayer name="pointlayer"></d3-maplayer>
            <d3-maplayer name="projectlayer"></d3-maplayer>
        </d3-map>
      </div>
      <d3-layermngr id="layermngr"></d3-layermngr>
    </div>
</core-header-panel>

</template>
<script>
var tmp;
Polymer({
        ready: function(){
            var self = this;
            this.projects = [];
            this.core = core;
          
            function reload_projects(){
                var data = _.filter(core.projects(), function(d){ 
                    return !d.deleted() && d.data('incidentlocation');
                });
                var feats = [];
                data.forEach(function(d){
                        var loc = d.data('incidentlocation');
                        var feat = {
                            type: 'Feature',
                            geometry:{
                                type: 'Point',
                                coordinates: [loc.lng,loc.lat]
                            }
                        }
                        feat.id = d.id();
                        feats.push(feat);
                });
                self.$['projectlayer'].newdata(feats);
            }
            
            
            
            core.projectStore().loaded.then(function(){
                self.projects = core.projects();
                reload_projects();
            });
            this.$['project-list'].addEventListener('activate', function(e) {
                console.log(e.detail);
              });
            tmp = self.$.mapelement;
			this.$.suggest.addEventListener('location', function(d){
				self.$.mapelement.center(d.detail.msg);
				self.$.mapelement.zoom(24);
				self.$.pointlayer.newdata([{type: 'Feature', geometry: {coordinates: d.detail.msg, type: 'Point'}}]);
				//self.$.mapelement.center([parseFloat(coords[0]), parseFloat(coords[1])]);
			});
        },
        attached: function(){
        	tmp = this.$.mapelement.map;
            this.$.layermngr.layers = this.$.mapelement.map.layers;
        }
});
</script>
</polymer-element>