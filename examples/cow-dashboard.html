<polymer-element name='cow-dashboard'>

<link rel="import" href="../elements/mypoly-wsstatus.html">
<link rel="import" href="../elements/mypoly-item.html">
<link rel="import" href="../elements/project-list.html">
<link rel="import" href="../elements/mypoly-map.html">
<link rel="import" href="../elements/mypoly-maplayer.html">
<link rel="import" href="../elements/mypoly-trainlayer.html">
<link rel="import" href="../elements/mypoly-twitterlayer.html">
<link rel="import" href="../elements/mypoly-maprasterlayer.html">
<link rel="import" href="../elements/mypoly-layermngr.html">
<link rel="import" href="../elements/mypoly-geoservermngr.html">
<link rel="import" href="../elements/mypoly-dialog.html">
<link rel="import" href="../elements/geodan-suggest.html">
<!--
<link rel="import" href="../elements/mypoly-peersforcelayout.html">
-->
<link rel="import" href="../elements/icm-login.html">
<link rel="import" href="../elements/icm-projectmenu.html">

<template>
<style>

core-header-panel {
    height: 100%;
}
.page {
    height: 100%;
    width: 100%;
}
d3-map {
    height: 100%;
    float: left;
    width: 100%;
}

.content {
    position: absolute; 
    height: 100%;
    width: 100%;
}
d3-layermngr {
    display: block;
    position: absolute;
    right: 0px;
    top: 0px;
    height: 100%;
    width: 200px;
    z-index: 101;
}

project-list {
	height: 100%;
}

</style>
<icm-login id="login"></icm-login>
<icm-projects id="projectmenu"></icm-projects>
<core-header-panel flex>
    <core-toolbar>
      <div>COW dashboard</div>
      <core-icon icon="search"></core-icon>
      <geodan-suggest id="suggest"></geodan-suggest>
      <paper-button raised on-tap="{{settings}}">Login</paper-button>
      <paper-button raised on-tap="{{projectmenu}}">Project</paper-button>
    </core-toolbar>
    <div horizontal layout>

      <div>
        <project-list id="project-list"></project-list>
      </div>
      <core-splitter minSize="200px" direction="left"></core-splitter>

      <div class='page content'>
        <d3-map id="mapelement" latitude="52.2" longitude="5.2" zoom="3">
            <d3-maprasterlayer 
                id="mapbox"
                type="tms"
                url="http://{s}.tiles.mapbox.com/v3/examples.map-i86nkdio/{z}/{x}/{y}.png"
            ></d3-rastermaplayer>
            <d3-maprasterlayer 
                id="mapbox-dark"
                type="tms"
                visible="false"
                url="http://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png"
            ></d3-rastermaplayer>
            
            <!--
            <d3-maprasterlayer 
                id="pico1"
                type="wms"
                url= "/service/pico/geoserver/pico/wms?"
                layers= 'pico:pico_sjv_sf'
            ></d3-rastermaplayer>
            -->
            <d3-maplayer id="pathlayer" name="Lines"></d3-maplayer>
            <d3-maplayer id="pointlayer" name="Points"></d3-maplayer>
            <d3-maplayer id="projectlayer" name="Projects"></d3-maplayer>
            <!--
            <d3-trainlayer id="trainlayer" name="Trains" interval="10000"></d3-trainlayer>
            <d3-twitterlayer id="twitterlayer" name="Tweets"></d3-twitterlayer>
            -->
        </d3-map>
      </div>
      <d3-layermngr id="layermngr"></d3-layermngr>
    </div>
</core-header-panel>

</template>
<script>
var tmp;
Polymer({
		projectid: null,
		created: function(){
			this.projects = [];
            this.core = core;
		},
        ready: function(){
            var self = this;
            function reload_projects(){
                var data = _.filter(core.projects(), function(d){ 
                    return !d.deleted() && d.data('incidentlocation');
                });
                var feats = [];
                data.forEach(function(d){
                        var loc = d.data('incidentlocation');
                        var feat = {
                            type: 'Feature',
                            geometry:{
                                type: 'Point',
                                coordinates: [loc.lng,loc.lat]
                            }
                        }
                        feat.id = d.id();
                        feats.push(feat);
                });
                self.$['projectlayer'].newdata(feats);
            }
            
            core.projectStore().loaded.then(function(){
                self.projects = core.projects();
                self.projectid = core._projectid;
                reload_projects();
            });
            
            this.$.projectmenu.addEventListener('projectselected', function(e) {
				core.project(e.detail.id);
				var items = core.project().items().filter(function(d){return !d.deleted() && d.data('type') && d.data('type') == 'feature';});
				var feats = [];
				items.forEach(function(d){
						feats.push(d.data('feature'));
				});
				self.$.pathlayer.newdata(feats);
				if (core.project().data('incidentLocation')){
					var loc = core.project().data('incidentLocation');
					self.$.mapelement.center([loc.lng,loc.lat]);
					self.$.mapelement.zoom(24);
				}
			});
			this.$.suggest.addEventListener('location', function(d){
				self.$.mapelement.center(d.detail.msg);
				self.$.mapelement.zoom(24);
				self.$.pointlayer.newdata([{type: 'Feature', style: {stroke: 'blue', fill: 'blue'},geometry: {coordinates: d.detail.msg, type: 'Point'}}]);
			});
        },
        attached: function(){
            this.$.layermngr.layers = this.$.mapelement.map.layers;
            this.$.layermngr.map = this.$.mapelement.map;
        },
        settings: function(){
        	this.$.login.open();
        },
        projectmenu: function(){
        	this.$.projectmenu.open();
        },
        projectidChanged: function(){
        	console.log('project id: ', this.projectid);
        }
});
</script>
</polymer-element>