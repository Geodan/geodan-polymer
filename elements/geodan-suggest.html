<polymer-element name="geodan-suggest">
  <template>
   <style>
   :host {
       display: block;
       float: left;
   }
   core-list {
	 width: 400px;
	 height: 500px;
	 position: absolute;
     	 
 }
 .selected {
	 color: red;
	 
 }
   
   </style>
   <input size=40 id="geosuggest" on-keydown="{{suggest}}">
   	<core-list id="suggestlist" data="{{suggestions}}">
	  <template>
		<div class="row {{ {selected: selected} | tokenList }}" on-click="{{lookup}}" value="{{model.id}}" name="{{model.displayname}}">
		  {{model.displayname}}
		</div>
	  </template>
	</core-list>
	
	
   <core-ajax
    id='suggest' 
    auto
    url="/service/geosearch/suggest"
    params='{"q":""}'
    handleAs="json"
    on-core-response="{{handleSuggestResponse}}"></core-ajax>
   </div>
   <core-ajax
    id='lookup' 
    auto
    url="/service/geosearch/lookup"
    params='{"q":""}'
    handleAs="json"
    on-core-response="{{handleLookupResponse}}"></core-ajax>
   </div>
   </template>
  <script>
  Polymer({
     iselected: 0,
  	 suggestions: [],
     ready: function(){
        
     },
     suggest: function(e){
     	 if (e.keyCode == 13){ //enter
     	 	 this.$.geosuggest.value =  this.$.suggestlist.selection.displayname;
     	 	 var id = this.$.suggestlist.selection.id;
     	 	 this.$.lookup.params = '{"q":"'+id+'"}';
     	 	 this.suggestions = [];
     	 }
     	 else if (e.keyCode == 40){ //down arrow
     	 	 this.iselected++;
     	 	 this.$.suggestlist.selectItem(this.iselected);
     	 }
     	 else if (e.keyCode == 38){ //up arrow
     	 	 this.iselected--;
     	 	 this.$.suggestlist.selectItem(this.iselected);
     	 }
     	 else {
     	 	 var self = this;
     	 	 window.setTimeout(function(){ //FIXME: WHY?!
     	 	 	var value = self.$.geosuggest.value;
     	 	 	console.log(value);
     	 	 	self.$.suggest.params = '{"q":"'+value+'"}';
     	 	 },100);
		 }
     },
     handleSuggestResponse: function(e){
     	 this.$.suggestlist.clearSelection();
     	 this.suggestions = e.detail.response.response.docs;
     	 this.iselected = 0;
     	 var self = this;
     	 window.setTimeout(function(){ //FIXME: this is ofcourse not the right way
     	 		 self.$.suggestlist.selectItem(self.iselected); 
     	 		 tmp = self.$.suggestlist;
     	 },100);
     },
     lookup: function(a,b,c){
     	 var id = c.getAttribute('value');
     	 var name = c.getAttribute('name');
     	 this.$.geosuggest.value = name;
     	 this.$.lookup.params = '{"q":"'+id+'"}';
     	 this.suggestions = [];
     },
     handleLookupResponse: function(e){
     	 var point = e.detail.response.response.docs[0] ? e.detail.response.response.docs[0].centroid[0] : "";
     	 this.fire('location', {msg: point});
     }
  });
  
  </script>
</polymer-element>