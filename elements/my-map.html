<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/core-scaffold/core-scaffold.html">
<link rel="import" href="../bower_components/core-list/core-list.html">
<link rel="import" href="../bower_components/core-item/core-item.html">
<link rel="import" href="../bower_components/core-selector/core-selector.html">
<link rel="import" href="../bower_components/core-menu/core-menu.html">
<link rel="import" href="../bower_components/core-pages/core-pages.html">
<link rel="import" href="../bower_components/core-overlay/core-overlay.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../bower_components/core-icons/maps-icons.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../elements/mypoly-map.html">
<link rel="import" href="../elements/mypoly-maplayer.html">
<link rel="import" href="../elements/mypoly-maprasterlayer.html">
<link rel="import" href="../elements/mypoly-layermngr.html">
<link rel="import" href="../elements/mypoly-geoservermngr.html">
<polymer-element name='my-app'>
<template>
    <style>
      d3-layermngr {
          display: block;
          position: absolute;
          left: 0px;
          top: 50px;
          height: 100%;
          width: 200px;
          z-index: 101;
      }
      d3-geoservermngr {
          display: block;
          position: absolute;
          right: 0px;
          top: 50px;
          height: 100%;
          width: 200px;
          z-index: 101;
      }
      d3-map {
          display: block;
          position: absolute;
          height: 100%;
          float: left;
          width: 100%;
      }
      
    </style>

    <d3-layermngr id="layermngr"></d3-layermngr>
    <d3-geoservermngr id="geoservermngr"></d3-geoservermngr>
    
    <d3-map id="item-map" latitude="52.2" longitude="5.2" zoom="3">
    
        <d3-maprasterlayer 
            id="mapbox"
            type="tms"
            url="http://{s}.tiles.mapbox.com/v3/examples.map-i86nkdio/{z}/{x}/{y}.png"
            ></d3-maprasterlayer>
            
         <d3-maprasterlayer 
            id="ahn"
            type="wms"
            layers="hoogtes"
            url="http://t3.edugis.nl/tiles/tilecache.py?map=maps/edugis/cache/hoogte.map";
            ></d3-maprasterlayer>
         <d3-maprasterlayer 
            id="laadpalen"
            type="wms"
            layers="pico:oplaadpalen"
            url="http://pico.ontw.geodan.nl:8080/geoserver/pico/wms?";
            ></d3-maprasterlayer>   
        <d3-maplayer id="pathlayer"></d3-maplayer>
        <d3-maplayer id="pointlayer"></d3-maplayer>
      </d3-map>
    
</template>

<script>
(function(){
      Polymer('my-app', {
        ready: function(){
            var self = this;
            function reload_items(id){
                /* Doing the map items */
                var data = _.filter(core.projects(id).items(), function(d){ 
                    return !d.deleted() && d.data('type') == 'feature' && d.data('feature').geometry.type != 'Point';
                });
                var feats = [];
                data.forEach(function(d){
                        feats.push(d.data('feature'));
                });
                self.$['pathlayer'].newdata(feats);
                var data = _.filter(core.projects(id).items(), function(d){ 
                    return !d.deleted() && d.data('type') == 'feature' && d.data('feature').geometry.type == 'Point';
                });
                var feats = [];
                data.forEach(function(d){
                        var feat = d.data('feature');
                        feat.id = d.id();
                        feats.push(feat);
                });
                self.$['pointlayer'].newdata(feats);
            }
            
            core.projectStore().loaded.then(function(){
                //core.project('test');
                //core.project().itemStore().on('datachange', function(d){
                //    reload_items('test');
                //});
                //core.project().itemStore().loaded.then(function(){
                //      reload_items('test');
                //});
            });
            self.$['layermngr'].tmp_layers = self.$['item-map'].layers();
            console.log(self.$['item-map'].layers());
            self.$['geoservermngr'].map = self.$['item-map'].map;
            
        }
      });
})();
</script>
</polymer-element>
