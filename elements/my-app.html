<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-scaffold/core-scaffold.html">
<link rel="import" href="../bower_components/core-list/core-list.html">
<link rel="import" href="../bower_components/core-item/core-item.html">
<link rel="import" href="../bower_components/core-selector/core-selector.html">
<link rel="import" href="../bower_components/core-menu/core-menu.html">
<link rel="import" href="../bower_components/core-pages/core-pages.html">
<link rel="import" href="../bower_components/core-overlay/core-overlay.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../bower_components/core-icons/maps-icons.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../elements/mypoly-wsstatus.html">
<link rel="import" href="../elements/mypoly-item.html">
<link rel="import" href="../elements/mypoly-list.html">
<link rel="import" href="../elements/mypoly-map.html">
<link rel="import" href="../elements/mypoly-maplayer.html">
<link rel="import" href="../elements/mypoly-maprasterlayer.html">
<link rel="import" href="../elements/mypoly-dialog.html">

<polymer-element name='my-app'>
<template>
    <style>
      mypoly-list {
          height: 100%;
          float: left;
          width: 100%;
      }
      d3-map {
          height: 100%;
          float: left;
          width: 100%;
      }
      .page {
        height: 100%;
        width: 100%;
      }
      leaflet-map {
        height: 100%;
        width: 100%;
      }
      core-header-panel {
          height: 100%;
      }
      core-overlay{
          background: white;
          
      }
      .content {
        position: absolute; 
        height: 100%;
        width: 100%;
      }
      
      core-pages {
          width: 100%;
          height: 100%;
          -webkit-user-select: none;
      }
      

    core-pages > div {
        width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
        
    </style>
    
  
  
  <core-scaffold>

  <core-header-panel navigation flex>
    <core-toolbar id="navheader">
      <span>Menu</span>
    </core-toolbar>
    
    <core-menu selected="0" selectedIndex="{{selected}}">
        <template repeat="{{page,i in pages}}">
          <core-item icon="{{page.icon}}" label="{{page.name}}"></core-item>
        </template>
    </core-menu>
    <mypoly-wsstatus></mypoly-wsstatus>
  </core-header-panel>
  <!--
  <span tool>
        COW admin
  </span>
  -->
  <div class="content">
  <core-pages selected="{{selected}}">
    <div class='page'>
      <mypoly-list id="socketserver-list" store="socketservers" on-edit-tap="edit" show="all" cols="protocol ip port"></mypoly-list>
    </div>
    <div class='page'>
      <mypoly-list id="user-list" store="users" show="all" cols="name"></mypoly-list>
    </div>
    <div class='page'>
      <mypoly-list id="peer-list" store="peers" show="all"></mypoly-list>
    </div>
    <div class='page'>
      <mypoly-list id="project-list" store="projects" show="all" cols="name"></mypoly-list>
    </div>
    <div class='page'>
      <mypoly-list id="item-list" store="items" show="all" cols="type feature beeld"></mypoly-list>
    </div>
    <div class='page'>
    <!--
      <leaflet-map id="item-map"  longitude="5.2" latitude="52.2" zoom="12">
       <template repeat={{p in points}}>
        <leaflet-circle longitude={{p.geometry.coordinates[0]}} latitude={{p.geometry.coordinates[0]}} radius="30">
        Round
        </leaflet-circle>
      </leaflet-map>
      <!-->
      <d3-map id="item-map" latitude="52.2" longitude="5.2" zoom="3">
        <d3-maprasterlayer 
            id="mapbox"
            type="tms"
            url="http://{s}.tiles.mapbox.com/v3/examples.map-i86nkdio/{z}/{x}/{y}.png"
        ></d3-maplayer>
        <d3-maplayer id="pathlayer"></d3-maplayer>
        <d3-maplayer id="pointlayer"></d3-maplayer>
      </d3-map>
      <!---->
    </div>
      
    </core-pages>
  </div>
</core-scaffold>
</template>

<script>
(function(){
      Polymer('my-app', {
        ready: function(){
            var self = this;
            this.pages = [
              {name: 'Socketservers', icon: 'list'},
              {name: 'Users', icon: 'list'},
              {name: 'Peers', icon: 'list'},
              {name: 'Projects', icon: 'list'},
              {name: 'Items', icon: 'list'},
              {name: 'Map', icon: 'maps:map'}
            ];
            function reload_items(id){
                
                self.$['item-list'].items = core.projects(id).items();
                
                /* Doing the map items */
                var data = _.filter(core.projects(id).items(), function(d){ 
                    return !d.deleted() && d.data('type') == 'feature' && d.data('feature').geometry.type != 'Point';
                });
                var feats = [];
                data.forEach(function(d){
                        feats.push(d.data('feature'));
                });
                
                self.$['item-map'].newdata(feats,'pathlayer');
                var data = _.filter(core.projects(id).items(), function(d){ 
                    return !d.deleted() && d.data('type') == 'feature' && d.data('feature').geometry.type == 'Point';
                });
                var feats = [];
                data.forEach(function(d){
                        var feat = d.data('feature');
                        feat.id = d.id();
                        feats.push(feat);
                });
                self.$['item-map'].newdata(feats,'pointlayer');
            }
            this.$['project-list'].addEventListener('activate-tap', function(e) {
                var id = e.detail.id;
                reload_items(id);
                core.project().itemStore().on('datachange', function(d){
                    reload_items(id);
                });
            });
        }
      });
})();
</script>
</polymer-element>